@page "/recipes/{Id:int}"
@using RecipeNow.Services
@inject IRecipeService RecipeService
@inject UserService UserService

<div class="container">
    <div class="card">
        <div class="card-body">
            @if (_recipeDetail is null)
            {
                <p>Lade Rezept…</p>
            }
            else
            {
                <h1>@_recipeDetail.name</h1>

                @if (_recipeDetail.images is not null && _recipeDetail.images.Any())
                {
                    var images = _recipeDetail.images.ToList();

                    <div id="recipeCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators">
                            @for (var i = 0; i < images.Count; i++)
                            {
                                <button type="button"
                                        data-bs-target="#recipeCarousel"
                                        data-bs-slide-to="@i"
                                        class="@(i == 0 ? "active" : null)"
                                        aria-current="@(i == 0 ? "true" : null)"
                                        aria-label="Slide @(i + 1)">
                                </button>
                            }
                        </div>

                        <div class="carousel-inner">
                            @for (var i = 0; i < images.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <div class="recipe-carousel-frame">
                                        <img class="recipe-carousel-img" src="@images[i]" alt="Rezeptbild @(i + 1)">
                                    </div>
                                </div>
                            }
                        </div>

                        <button class="carousel-control-prev" type="button" data-bs-target="#recipeCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>

                        <button class="carousel-control-next" type="button" data-bs-target="#recipeCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                }
                else
                {
                    <p>Keine Bilder vorhanden.</p>
                }

                <p>@_recipeDetail.description</p>

                @if (_isSameUser)
                {
                    <a href="/recipes/edit/@_recipeDetail.id" class="btn btn-primary">Edit</a>
                }
            }
        </div>
    </div>
</div>




@code {
    [Parameter] public int Id { get; set; }
    private bool _isSameUser;
    private RecipeDetail _recipeDetail;
    public sealed class RecipeDetail
    {
        public required IEnumerable<string> images { get; init; } = new List<string>();
        public required string name { get; init; } = "";
        public required string description { get; init; } = "";
        public required string user_name { get; init; } = "0";
        public required int id { get; set; } = 0;
    }

    protected override async Task OnInitializedAsync()
    {
        var imagePaths = new List<string>();
        var temp = await RecipeService.GetByIdAsync(Id);
        foreach (var image in temp.Images)
        {
            imagePaths.Add(image.ImagePath);
        }
        _recipeDetail = new RecipeDetail()
        {
            description = temp?.Description,
            id = temp.Id,
            images = imagePaths,
            name = temp.Name,
            user_name = temp.UserId
        };
        var currentUser = await UserService.GetUserAsync();
        var currentUserId = currentUser.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        _isSameUser = !string.IsNullOrWhiteSpace(currentUserId)
                      && string.Equals(temp.UserId, currentUserId, StringComparison.Ordinal);
    }
}